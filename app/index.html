<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Esplanade</title>
    <meta name="viewport" content="width=device-width" />
    <!--[if lt IE 9]><script src="//static.jstree.com/3.2.1/assets/html5.js"></script><![endif]-->

    <meta name="robots" content="index,follow" />

    <script>
        WR = "/";
    </script>
    <meta property="og:type" content="website" />
</head>

<body class="Site">
    <header class="Site-header" id="Site-header">
        <img src="//chibitronics.com/ltc/chibitronics_demo-header.png" hspace="10" width="200" height="46">
        <div class="red_button" id="upload_button">Upload</div>
        <div class="red_button" id="examples_button">Examples</div>
        <div class="red_button" id="saveas_button">Save As...</div>
        <div style="display: none; color: blue; text-decoration: underline; cursor: pointer; cursor: hand;" id="stoprunning">Stop running</div>
        <select name="fqbn" id="fqbn">
            <option value="chibitronics:esplanade:code" selected>Chibitronics Code</option>
            <option value="arduino:avr:uno">Arduino Uno</option>
            <option value="arduino:sam:arduino_due_x_dbg">Arduino Due (Programming Port)</option>
            <option value="arduino:sam:arduino_due_x">Arduino Due (Native Port)</option>
        </select>
        <audio id="a" controls></audio>
        <div id="buildoutput" style="display: none"></div>
    </header>
    <div id="main" class="Site-content">
        <div id="sidebar">
            <div id="treething"></div>
        </div>

        <div id="saveAsDialog" style="display:none" title="Save As...">
            <form>
                <fieldset>
                    <label for="saveas_filename">Filename</label>
                    <input type="text" name="saveas_filename" id="saveas_filename" class="text ui-widget-content ui-corner-all">
                    <input type="submit" tabindex="-1" style="position: absolute; top: -1000px">
                </fieldset>
            </form>
        </div>

        <div id="internal_error_dialog" style="display:none" title="Internal Error">
            <p>An internal compiler error occurred:</p>
            <pre id="internal_error_text"></pre>
        </div>

        <form method="post" id="show-result" target="result" action="/build">
            <div id="examples_list" class="ExamplesList">
                <ol>
                <li class="ExampleCategory">Basics</li>
                <ul>
                    <li class="ExampleItem"><a href="examples/01.Basics/AnalogReadSerial/AnalogReadSerial.ino">AnalogReadSerial</a></li>
                    <li class="ExampleItem"><a href="examples/01.Basics/BareMinimum/BareMinimum.ino">BareMinimum</a></li>
                    <li class="ExampleItem"><a href="examples/01.Basics/Blink/Blink.ino">Blink</a></li>
                    <li class="ExampleItem"><a href="examples/01.Basics/DigitalReadSerial/DigitalReadSerial.ino">DigitalReadSerial</a></li>
                    <li class="ExampleItem"><a href="examples/01.Basics/Fade/Fade.ino">Fade</a></li>
                    <li class="ExampleItem"><a href="examples/01.Basics/ReadAnalogVoltage/ReadAnalogVoltage.ino">ReadAnalogVoltage</a></li>
                </ul>
                <li class="ExampleCategory">Digital</li>
                <ul>
                    <li class="ExampleItem"><a href="examples/02.Digital/BlinkWithoutDelay/BlinkWithoutDelay.ino">BlinkWithoutDelay</a></li>
                    <li class="ExampleItem"><a href="examples/02.Digital/Button/Button.ino">Button</a></li>
                    <li class="ExampleItem"><a href="examples/02.Digital/Debounce/Debounce.ino">Debounce</a></li>
                    <li class="ExampleItem"><a href="examples/02.Digital/DigitalInputPullup/DigitalInputPullup.ino">DigitalInputPullup</a></li>
                    <li class="ExampleItem"><a href="examples/02.Digital/ResistiveTouch/ResistiveTouch.ino">ResistiveTouch</a></li>
                    <li class="ExampleItem"><a href="examples/02.Digital/StateChangeDetection/StateChangeDetection.ino">StateChangeDetection</a></li>
                    <li class="ExampleItem"><a href="examples/02.Digital/toneMelody/toneMelody.ino">toneMelody</a></li>
                    <li class="ExampleItem"><a href="examples/02.Digital/toneMultiple/toneMultiple.ino">toneMultiple</a></li>
                    <li class="ExampleItem"><a href="examples/02.Digital/tonePitchFollower/tonePitchFollower.ino">tonePitchFollower</a></li>
                </ul>
                <li class="ExampleCategory">Analog</li>
                <ul>
                    <li class="ExampleItem"><a href="examples/03.Analog/AnalogInOutSerial/AnalogInOutSerial.ino">AnalogInOutSerial</a></li>
                    <li class="ExampleItem"><a href="examples/03.Analog/AnalogInput/AnalogInput.ino">AnalogInput</a></li>
                    <li class="ExampleItem"><a href="examples/03.Analog/Calibration/Calibration.ino">Calibration</a></li>
                    <li class="ExampleItem"><a href="examples/03.Analog/Fading/Fading.ino">Fading</a></li>
                    <li class="ExampleItem"><a href="examples/03.Analog/Smoothing/Smoothing.ino">Smoothing</a></li>
                </ul>
                <li class="ExampleCategory">Communication</li>
                <ul>
                    <li class="ExampleItem"><a href="examples/04.Communication/ASCIITable/ASCIITable.ino">ASCIITable</a></li>
                    <li class="ExampleItem"><a href="examples/04.Communication/Dimmer/Dimmer.ino">Dimmer</a></li>
                    <li class="ExampleItem"><a href="examples/04.Communication/Graph/Graph.ino">Graph</a></li>
                    <li class="ExampleItem"><a href="examples/04.Communication/PhysicalPixel/PhysicalPixel.ino">PhysicalPixel</a></li>
                    <li class="ExampleItem"><a href="examples/04.Communication/SerialEvent/SerialEvent.ino">SerialEvent</a></li>
                    <li class="ExampleItem"><a href="examples/04.Communication/VirtualColorMixer/VirtualColorMixer.ino">VirtualColorMixer</a></li>
                </ul>
                <li class="ExampleCategory">Control</li>
                <ul>
                    <li class="ExampleItem"><a href="examples/05.Control/Arrays/Arrays.ino">Arrays</a></li>
                    <li class="ExampleItem"><a href="examples/05.Control/ForLoopIteration/ForLoopIteration.ino">ForLoopIteration</a></li>
                    <li class="ExampleItem"><a href="examples/05.Control/IfStatementConditional/IfStatementConditional.ino">IfStatementConditional</a></li>
                    <li class="ExampleItem"><a href="examples/05.Control/switchCase2/switchCase2.ino">switchCase2</a></li>
                    <li class="ExampleItem"><a href="examples/05.Control/switchCase/switchCase.ino">switchCase</a></li>
                    <li class="ExampleItem"><a href="examples/05.Control/WhileStatementConditional/WhileStatementConditional.ino">WhileStatementConditional</a></li>
                </ul>
                <li class="ExampleCategory">Strings</li>
                <ul>
                    <li class="ExampleItem"><a href="examples/08.Strings/CharacterAnalysis/CharacterAnalysis.ino">CharacterAnalysis</a></li>
                    <li class="ExampleItem"><a href="examples/08.Strings/StringAdditionOperator/StringAdditionOperator.ino">StringAdditionOperator</a></li>
                    <li class="ExampleItem"><a href="examples/08.Strings/StringAppendOperator/StringAppendOperator.ino">StringAppendOperator</a></li>
                    <li class="ExampleItem"><a href="examples/08.Strings/StringCaseChanges/StringCaseChanges.ino">StringCaseChanges</a></li>
                    <li class="ExampleItem"><a href="examples/08.Strings/StringCharacters/StringCharacters.ino">StringCharacters</a></li>
                    <li class="ExampleItem"><a href="examples/08.Strings/StringComparisonOperators/StringComparisonOperators.ino">StringComparisonOperators</a></li>
                    <li class="ExampleItem"><a href="examples/08.Strings/StringConstructors/StringConstructors.ino">StringConstructors</a></li>
                    <li class="ExampleItem"><a href="examples/08.Strings/StringIndexOf/StringIndexOf.ino">StringIndexOf</a></li>
                    <li class="ExampleItem"><a href="examples/08.Strings/StringLength/StringLength.ino">StringLength</a></li>
                    <li class="ExampleItem"><a href="examples/08.Strings/StringLengthTrim/StringLengthTrim.ino">StringLengthTrim</a></li>
                    <li class="ExampleItem"><a href="examples/08.Strings/StringReplace/StringReplace.ino">StringReplace</a></li>
                    <li class="ExampleItem"><a href="examples/08.Strings/StringStartsWithEndsWith/StringStartsWithEndsWith.ino">StringStartsWithEndsWith</a></li>
                    <li class="ExampleItem"><a href="examples/08.Strings/StringSubstring/StringSubstring.ino">StringSubstring</a></li>
                    <li class="ExampleItem"><a href="examples/08.Strings/StringToIntRGB/StringToIntRGB.ino">StringToIntRGB</a></li>
                    <li class="ExampleItem"><a href="examples/08.Strings/StringToInt/StringToInt.ino">StringToInt</a></li>
                </ul>
                <li class="ExampleCategory">USB</li>
                <ul>
                    <li class="ExampleItem"><a href="examples/09.USB/KeyboardAndMouseControl/KeyboardAndMouseControl.ino">KeyboardAndMouseControl</a></li>
                    <li class="ExampleItem"><a href="examples/09.USB/Keyboard/KeyboardLogout/KeyboardLogout.ino">KeyboardLogout</a></li>
                    <li class="ExampleItem"><a href="examples/09.USB/Keyboard/KeyboardMessage/KeyboardMessage.ino">KeyboardMessage</a></li>
                    <li class="ExampleItem"><a href="examples/09.USB/Keyboard/KeyboardReprogram/KeyboardReprogram.ino">KeyboardReprogram</a></li>
                    <li class="ExampleItem"><a href="examples/09.USB/Keyboard/KeyboardSerial/KeyboardSerial.ino">KeyboardSerial</a></li>
                    <li class="ExampleItem"><a href="examples/09.USB/Mouse/ButtonMouseControl/ButtonMouseControl.ino">ButtonMouseControl</a></li>
                    <li class="ExampleItem"><a href="examples/09.USB/Mouse/JoystickMouseControl/JoystickMouseControl.ino">JoystickMouseControl</a></li>
                </ul>
                <li class="ExampleCategory">chibitronics</li>
                <ul>
                    <li class="ExampleItem"><a href="examples/chibitronics/neopixel/neopixel.ino">neopixel</a></li>
                    <li class="ExampleItem"><a href="examples/chibitronics/PhysicalProgramming/physical-programming.ino">physical-programming</a></li>
                    <li class="ExampleItem"><a href="examples/chibitronics/threading/threading.ino">threading</a></li>
                </ul>
                </ol>
            </div>
            <div id="code_editor">

                <textarea id="code_editor_textarea">void setup() {
  ;
}

void loop() {
  ;
}</textarea>
            </div>
        </form>
    </div>
    <footer class="Site-footer" id="Site-footer">
        <canvas id="wavStrip"></canvas>
    </footer>

    <!--
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.15.2/codemirror.min.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.15.2/addon/lint/lint.min.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/jstree/3.3.1/themes/default/style.min.css" />
-->

    <!-- build:css main.min.css -->
    <link rel="stylesheet" href="lib/codemirror.css" />
    <link rel="stylesheet" href="css/lint.css" />

    <link rel="stylesheet" href="css/main.css" />
    <!-- endbuild -->

    <!--
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jstree/3.3.1/jstree.min.js" type="text/javascript" charset="utf-8"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.15.2/codemirror.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.15.2/addon/lint/lint.js" type="text/javascript" charset="utf-8"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.15.2/mode/clike/clike.min.js" type="text/javascript" charset="utf-8"></script>
-->

    <!-- build:js main.min.js -->
    <script src="lib/codemirror.js"></script>
    <script src="lib/lint.js"></script>
    <script src="mode/clike/clike.js"></script>
    <script src="lib/chibi-lint.js"></script>

    <script src="js/afsk-encoder.js"></script>
    <script src="js/modulate-controller.js"></script>
    <script src="js/modulate.js"></script>
    <script src="js/murmurhash3_gc.js"></script>
    <script src="js/spark-md5.js"></script>

    <script src="lib/pcm.js"></script>
    <!-- endbuild -->

    <script type="text/javascript">
        var editor;
        var codeobj = new Object();
        var mod_controller;
        var totalSize;

        Number.prototype.toFixedDown = function(digits) {
            var re = new RegExp("(\\d+\\.\\d{" + digits + "})(\\d)"),
                m = this.toString().match(re);
            return m ? parseFloat(m[1]) : this.valueOf();
        };

        function buildResult(results, textStatus, status, jqXHR) {
            if (status !== 200) {
                console.log("Don't know what to do.  Backend failure?");
                return;
            }
            results = JSON.parse(results);
            if (results.success) {
                document.getElementById("buildoutput").innerHTML = "Build complete";

                totalSize = results.size;
                var data = atob(results.output);
                if (mod_controller)
                    mod_controller.stop();
                mod_controller = new ModulationController({
                    canvas: document.getElementById("wavStrip"),
                    endCallback: function() {
                        document.getElementById("Site-footer").style.display = 'none';
                    }
                });
                mod_controller.transcodePcm(data);

                document.getElementById("Site-footer").style.display = '';
            } else {
                editor.chibi_error_string = results.message;
                editor.performLint();
            }
        }

        function clickUpload() {
            document.getElementById("buildoutput").innerHTML = "Building code...";

            // Play empty data onclick to enable audio playback.
            var audioTag = document.getElementById("a");
            var pcmObj = new pcm({
                channels: 1,
                rate: 44100,
                depth: 8
            }).toWav([0, 0, 0, 0]);
            audioTag.src = pcmObj.encode();
            audioTag.play();

            if (mod_controller)
                mod_controller.stop();
            codeobj = {
                "files": [{
                    "filename": "project.ino",
                    "content": editor.getValue()
                }],
                "format": "binary",
                "version": "167",
                "libraries": [],
                "fqbn": "chibitronics:esplanade:code"
            }

            // Clear out the old error message.
            editor.chibi_error_string = "";
            editor.performLint();

            var request = new window.XMLHttpRequest();
            request.onreadystatechange = function() {
                if (request.readyState === 4) {
                    buildResult(request.response, request.statusText, request.status, request);
                }
            }
            request.open('POST', "/compile", true);
            request.send(JSON.stringify(codeobj));

            return false;
        }

        function clickExamples() {
            var editorBox = document.getElementById("code_editor");
            var examplesBox = document.getElementById("examples_list");

            if (editorBox.style.display === 'none') {
                examplesBox.style.display = 'none';
                editorBox.style.display = 'block';
            }
            else {
                examplesBox.style.display = 'block';
                editorBox.style.display = 'none';
            }

            return false;
        }
        //var saveAsFilename = $("#saveas_filename");
        //var allSaveAsFields = $([]).add(saveAsFilename);

        function saveFileAs() {
            allSaveAsFields.removeClass("ui-state-error");

            var localSketches = localStorage.getItem('sketches');
            if (localSketches) {
                console.log("localSketches: " + localSketches);
                localSketches = JSON.parse(localSketches);
            } else
                localSketches = {};

            localSketches[saveAsFilename.val()] = editor.getValue();
            localStorage.setItem('sketches', JSON.stringify(localSketches));
            saveAsDialog.dialog("close");
        }

/*
            $("#internal_error_dialog").dialog({
                autoOpen: false,
                height: 300,
                width: 600
            });
            $("#stoprunning").click(function() {
                if (mod_controller)
                    mod_controller.stop();
            });

            saveAsDialog = $("#saveAsDialog").dialog({
                autoOpen: false,
                height: 300,
                width: 350,
                modal: true,
                buttons: {
                    "Save as": saveFileAs,
                    Cancel: function() {
                        saveAsDialog.dialog("close");
                    }
                },
                close: function() {
                    saveasForm[0].reset();
                    allSaveAsFields.removeClass("ui-state-error");
                }
            });
            saveasForm = saveAsDialog.find("form").on("submit", function(event) {
                event.preventDefault();
                saveFileAs();
            });

            $("#saveas_button").click(function() {
                $("#saveAsDialog").dialog("open");
            });

            $("#examples_button").click(function() {
                var examples_window = $("#sidebar");
                if (examples_window.is(":visible")) {
                    examples_window.hide({
                        effect: "blind",
                        easing: "swing",
                        direction: "right"
                    });
                    this.innerHTML = "Show Examples";
                } else {
                    examples_window.show({
                        effect: "blind",
                        easing: "swing",
                        direction: "right"
                    });
                    this.innerHTML = "Hide Examples";
                }
            });
            */

        function initializeEditor() {
            editorNode = document.getElementById("code_editor_textarea");
            editor = CodeMirror.fromTextArea(editorNode, {
                value: editorNode.value,
                lineNumbers: true,
                matchBrackets: true,
                mode: "text/x-c++src",
                scrollbarStyle: "null",
                lint: true,
                gutters: ["CodeMirror-lint-markers"],
                useCPP: true
            });
            var mac = CodeMirror.keyMap.default == CodeMirror.keyMap.macDefault;
            CodeMirror.keyMap.default[(mac ? "Cmd" : "Ctrl") + "-Space"] = "autocomplete";
        }

/*
            $('#treething').jstree({
                    "core": {
                        "animation": 0,
                        "check_callback": true,
                        "themes": {
                            "stripes": true
                        },
                        'data': function(node, callback) {
                            if (node.id === "#") {
                                $.get("items.json", "", callback);
                            } else if (node.id === "examples") {
                                $.get("examples.json", "", callback);
                            } else if (node.id === "local") {
                                var localSketches = localStorage.getItem('sketches');
                                if (localSketches)
                                    localSketches = JSON.parse(localSketches);
                                else
                                    localSketches = {};

                                var items = new Array();
                                for (var file in localSketches) {
                                    if (!localSketches.hasOwnProperty(file))
                                        continue;
                                    items.push({
                                        "id": file,
                                        "text": file,
                                        "children": false,
                                        "type": "root"
                                    });
                                }

                                if (items.length)
                                    callback(items);
                                else
                                    callback(["(None)"]);
                            } else {
                                callback([]);
                            }
                        }
                    },
                    "types": {
                        "#": {
                            "max_children": 1,
                            "max_depth": 4,
                            "valid_children": ["root"]
                        },
                        "root": {
                            "icon": "images/tree-icon.png",
                            "valid_children": ["default"]
                        },
                        "default": {
                            "valid_children": ["default", "file"]
                        },
                        "file": {
                            "icon": "glyphicon glyphicon-file",
                            "valid_children": []
                        }
                    },
                    "plugins": [
                        "state", "types", "wholerow"
                    ]
                })
                .on('changed.jstree', function(e, data) {
                    if (data && data.selected && data.selected.length) {
                        console.log("Selected " + data.selected);

                        if (data.node.parent === "local") {
                            var localSketches = localStorage.getItem('sketches');
                            if (localSketches)
                                localSketches = JSON.parse(localSketches);
                            else
                                localSketches = {};
                            editor.setValue(localSketches[data.node.id]);
                        } else if (data.node.data) {
                            $.get(data.node.data, function(d) {
                                editor.setValue(d);
                            });
                        } else {
                            var ref = $('#treething').jstree(true);
                            ref.open_node(data.node);
                        }
                    }
                });
*/
            /* Resize the header */
            function resizeHeader() {
                var header = document.getElementById("Site-header");
                var height = header.offsetHeight;
                document.getElementById("main").style.marginTop = height + 'px';
                header.style.top = 0;
            }
            window.onresize = resizeHeader;

            document.getElementById("upload_button").onclick = clickUpload;
            document.getElementById("examples_button").onclick = clickExamples;
/*
        $(window).on('resize', function() {
            var header = document.getElementById("Site-header");
            var height = header.offsetHeight;
            document.getElementById("main").style.marginTop = height + 'px';
            header.style.top = 0;
        });

        // This will unblock audio on iOS devices.  Otherwise, they will have silence.
        if (!("audioContext" in window))
            window.audioContext = new(window.AudioContext || window.webkitAudioContext)();
        var had_touch = false;
        document.addEventListener("touchend", function() {
            if (had_touch)
                return;
            // play empty buffer to unmute audio
            var buffer = window.audioContext.createBuffer(2, 4096, window.audioContext.sampleRate);
            var source = window.audioContext.createBufferSource();
            source.buffer = buffer;
            source.connect(window.audioContext.destination);
            source.start(0);
            had_touch = true;
        });
        */

        function hideShowExampleCategory(e) {
            var elem = e.target;
            if (elem.nextElementSibling.style.display === '')
                elem.nextElementSibling.style.display = 'none';
            else
                elem.nextElementSibling.style.display = '';
            return false;
        }

        function loadExampleFromLink(e) {

            var request = new window.XMLHttpRequest();
            var target = e.target;

            // If we clicked on the <LI> outside of the link, manually select the <A> tag inside.
            if (e.target.tagName === "LI")
                target = target.firstChild;

            request.onreadystatechange = function() {
                if (request.readyState === 4) {

                    var editorBox = document.getElementById("code_editor");
                    var examplesBox = document.getElementById("examples_list");

                    examplesBox.style.display = 'none';
                    editorBox.style.display = 'block';

                    if (request.status == 200)
                        editor.setValue(request.response);
                }
            }
            request.open('GET', target.href, true);
            request.send();

            return false;
        }

        function fixupExamples() {
            var exampleCategories = document.getElementsByClassName("ExampleCategory");
            for (var i = 0; i < exampleCategories.length; i++) {
                var e = exampleCategories[i];

                // Mark all child categories as hidden
                e.nextElementSibling.style.display = 'none';

                // Set it up so we can click to expand
                e.onclick = hideShowExampleCategory;
            }

            var exampleItems = document.getElementsByClassName("ExampleItem");
            for (var i = 0; i < exampleItems.length; i++) {
                var e = exampleItems[i];

                e.firstChild.onclick = function() { return false; }
                e.onclick = loadExampleFromLink;
            }
        }

        initializeEditor();
        resizeHeader();
        fixupExamples();
    </script>

</body>

</html>